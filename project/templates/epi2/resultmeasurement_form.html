{% extends 'portal.html' %}

{% load selectable_tags %}
{% load crispy_forms_tags %}

{% block title %}
  {% include "hawc/siteTitle.html" with crumbs=form.instance.get_crumbs crud=crud %}
{% endblock title %}

{% block extrastyle %}
  {% include_ui_theme %}
{% endblock %}

{% block breadcrumbs %}
  {% include "hawc/breadcrumbs.html" with crumbs=form.instance.get_crumbs crud=crud %}
{% endblock %}

{% block content %}
  <div id="rForm">
    {% crispy form %}
  </div>

  <div id="rFormset" style="display: {% if form.groups.value %}inline{% else %}none{% endif %}">
    <legend id="formsetName"></legend>
    {% if crud == "Create" %}
      <p class="help-block">
        Add results to each result
      </p>
    {% endif %}
    {% include "hawc/_formset_table_template.html" with showDeleteRow=False %}
  </div>
{% endblock %}


{% block extrajs %}
  {{ form.media }}
  <script type="text/javascript">
    $(document).on('ready', function(){

      var elFormset = $("#rFormset").insertBefore($('#rForm .form-actions')),
          fs = new DynamicFormset(elFormset, 'form', {oneFormRequired: true}),
          group_id = {{ form.groups.value|default:"null" }},
          updateFormset = function(d){
            if (_.isUndefined(d)) return elFormset.hide();

            // update formset name
            $("#formsetName").text(d.name);

            // remove all but first row
            fs.$el.find('tbody tr:gt(0)').remove();

            // reset first-row values
            fs.clearForm(fs.$el.find('tbody tr').slice(0, 1));

            // add rows based on number of groups in collection
            _(d.groups.length-1).times(fs.addForm.bind(fs));

            // bind each row to a different group-id
            fs.$el.find('tbody tr').each(function(i, v){
              $(v).find('.groupField').val(d.groups[i].id);
            });
            updateLabels();

            elFormset.show();
          }, updateLabels = function(){
            fs.$el.find('tbody tr').each(function(i, tr){
              var tr = $(tr);
              tr.find('.groupFieldLabel').text(tr.find('.groupField option:selected').text());
            });
          };

      // add group labels
      $(".groupField").each(function(i,v){
        $('<strong class="groupFieldLabel">').insertAfter(v);
      });
      updateLabels();

      // bind formset change to group-change
      $('#id_groups').change(function(){
        var val = parseInt(this.value),
            url = "/epi2/api/groups/{0}/".printf(val);
        if (_.isNaN(val)){
          updateFormset();
        } else if (val !== group_id){
          $.get(url, updateFormset);
          group_id = val;
        }
      }).trigger('change');

      // pass group-id back to server
      $("form").submit(function(){
        $('#id_groups').prop('disabled', false);
        return true;
      });

    });
  </script>
{% endblock extrajs %}
