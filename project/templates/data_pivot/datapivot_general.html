{% extends 'portal.html' %}


{% block title %} Data Pivot | HAWC {% endblock title %}

{% block extrastyle %}
  {% if debug %}
    <link href="{{STATIC_URL}}debug/bootstrap-lightbox/0.6.1/bootstrap-lightbox.css" rel="stylesheet" type="text/css">
    <link href="{{STATIC_URL}}debug/spectrum/1.3.0/css/spectrum.css" rel="stylesheet" type="text/css">
  {% else %}
    <link href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-lightbox/0.6.1/bootstrap-lightbox.min.css" rel="stylesheet" type="text/css">
    <link href="//cdnjs.cloudflare.com/ajax/libs/spectrum/1.3.0/css/spectrum.min.css" rel="stylesheet" type="text/css">
  {% endif %}
{% endblock %}

{% block breadcrumbs %}
  <li class="active">Data Pivot<span class="divider">/</span></li>
{% endblock %}

{% block content %}

    <h1>HAWC Data Pivot</h1>
    <div id="data_pivot_form">
        <p>This web-application imports a flat text file and allows for custom plots to be generated which show selected data column text and a numerical forest-plot. High-quality images can also be downloaded and used in reporting. This application is inspired from the NTP <a href="http://ntp.niehs.nih.gov/?objectid=1DF7D40E-A957-9727-733C9B89E243634B">Meta Data Viewer software</a>. An example visualization is shown here:<br>

          <a data-toggle="lightbox" href="#demo_image">
            <img class="img-rounded" src="{{ STATIC_URL }}data_pivot/img/QuickStart.png" height="300" width="350">
          </a>
        </p>

        <div id="demo_image" class="lightbox hide fade"  tabindex="-1" role="dialog" aria-hidden="true">
          <div class='lightbox-content'>
            <img src="{{ STATIC_URL }}data_pivot/img/QuickStart.png"></p>
          </div>
        </div>

        <p>To begin, download the sample <a href="{{ STATIC_URL }}data_pivot/QuickStart.txt">text file</a> and optionally the <a href="{{ STATIC_URL }}data_pivot/QuickStart.json">settings file</a> into the form below. After loading the data into the viewer, you can create a custom plot by changing the settings in the specified tabs. When using HAWC in an actual assessment, data can be automatically queried from the database and can loaded into the application automatically, rather than manually uploading an input file.</p>

        <forms class="form-horizontal" action=".">
          <legend>Load Your Dataset</legend>
          <span class='help-block'></span><br>
          <div class="control-group form-row">
            <label for="file_txt" class="control-label">Dataset:</label>
            <div class="controls">
              <input type="file" id="file_txt" />
              <span class='help-block'>This file must be in unicode tabular format. For more details on saving in this format from Excel, <a href="{% url 'data_pivot:excel-unicode' %}" target="_blank">click here</a>.</span>
            </div>
          </div>

          <div class="control-group form-row">
            <label for="file_json" class="control-label">Settings (optional):</label>
            <div class="controls">
              <input type="file" id="file_json" />
              <span class='help-block'>This file is created by the data-pivot software. If a file is not loaded, defaults will be used. After customizing your output, settings can be saved in case you'd like to use the same settings in the future.</span>
            </div>
          </div>
          <div class="form-actions">
            <button class="btn btn-primary" id="load_data_pivot">Load Dataset</button>
          </div>
        </form>
    </div>

    <div class='row-fluid' id='data_pivot' style='display:none;'>
        <ul class="nav nav-tabs">
            <li class="active"><a href="#dp_data" data-toggle="tab">Data</a></li>
            <li><a href="#dp_settings" data-toggle="tab">Settings</a></li>
            <li><a href="#dp_display" data-toggle="tab">Visualization</a></li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane active" id="dp_data"></div>
            <div class="tab-pane" id="dp_settings"></div>
            <div class="tab-pane" id="dp_display"></div>
        </div>
    </div>
{% endblock %}


{% block extrajs %}
  {% if debug %}
    <script src="{{STATIC_URL}}debug/bootstrap-lightbox/0.6.1/bootstrap-lightbox.js" type="text/javascript"></script>
    <script src="{{STATIC_URL}}debug/spectrum/1.3.0/js/spectrum.js" type="text/javascript"></script>
  {% else %}
    <script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-lightbox/0.6.1/bootstrap-lightbox.min.js" type="text/javascript"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/spectrum/1.3.0/js/spectrum.min.js" type="text/javascript"></script>
  {% endif %}
  <script src="{{STATIC_URL}}js/FileSaver.js" type="text/javascript"></script>
  <script src="{{STATIC_URL}}data_pivot/js/data_pivot.js" type="text/javascript"></script>
  <script type="text/javascript">
    $(document).ready(function(){
      (function(){
          var load_dataset = function(){
              // load a CSV data set. This is required. After complete, try
              // to load a settings file.
              var file_txt = $('#file_txt')[0].files[0],
                  reader = new FileReader();

              if (!file_txt){
                alert('No data file found!');
                return;
              }

              reader.onload = function(e) {
                var data = d3.tsv.parse(e.target.result,
                    function(d, i){return DataPivot.massage_row(d, i); });
                load_json(data);
              };

              reader.onerror = function(stuff){
                alert('An error has occurred importing CSV file. Please check the format.');
              };
              reader.readAsText(file_txt);
          }, load_json = function(data){
              // Load a settings file, if one is present
              var json_file = $('#file_json')[0].files[0],
                  reader = new FileReader(),
                  settings;

              if (json_file){
                reader.onload = function(e) {
                  settings = JSON.parse(e.target.result);
                  create_data_pivot(data, settings);
                };

                reader.onerror = function(stuff){
                  alert('An error has occurred importing the JSON settings file. Please check the format.');
                };

                reader.readAsText(json_file);
              } else {
                create_data_pivot(data);
              }
          }, create_data_pivot = function(data, settings){
              $('#data_pivot_form').fadeOut();
              window.dp = new DataPivot(data,
                                        settings,
                                        {"update": true,
                                         "container": '#data_pivot',
                                         "data_div": '#dp_data',
                                         "settings_div": '#dp_settings',
                                         "display_div": '#dp_display'});
          };
          $('#load_data_pivot').on('click', load_dataset);
      }());
    });
  </script>
{% endblock %}
