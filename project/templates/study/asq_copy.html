{% extends 'portal.html' %}

{% load add_class %}

{% block title %}
  {{assessment}} | Copy Risk of Bias Approach | HAWC
{% endblock %}

{% block extrastyle %}
  <link rel="stylesheet" type="text/css" href="{{STATIC_URL}}wysihtml5/css/bootstrap-wysihtml5.css" />
{% endblock %}

{% block breadcrumbs %}
  <li><a href="{% url 'assessment:detail' pk=assessment.pk %}">{{assessment}}</a><span class="divider">/</span></li>
  <li><a href="{% url 'study:asq_detail' assessment.pk %}">Risk-of-bias requirements</a><span class="divider">/</span></li>
  <li class="active"> Copy risk-of-bias approach <span class="divider">/</span></li>
{% endblock %}


{% block content %}
  <div class="row-fluid">
    <form class="span8 offset2 form-horizontal" action="." method="post">

      {% csrf_token %}

      <fieldset>
        <legend>Copy risk of bias approach from existing assessments</legend>
        <p class="help-block">Copy risk of bias metrics and domains from an existing HAWC assessment which you have access to.</p><br>

        {{ form.non_field_errors|add_class:"alert alert-error" }}

        {% for field in form %}
          <div class="control-group form-row">
            <!-- {{field.label_tag|add_class:"control-label"}} -->
              <div class="controls">
                {{field}}
                <span class='help-inline'>{{field.help_text}}</span>
            </div>
            {{field.errors|add_class:"alert alert-error"}}
          </div>
        {% endfor %}
      </fieldset>

      <div class="alert alert-block">
        <a class="close" href="#" data-dismiss="alert">Ã—</a>
        <h4>Warning!</h4>
        <p>Copying the Risk of Bias domains and metrics from another assessment will the existing
        assessment domains and metrics.</p>
      </div>

      <b>Risk of Bias approach for selected assessment:</b>
      <div id="approach"></div>

      <div class="row-fluid">
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Copy risk of bias approach from existing assessment</button>
          <a class="btn" href="{% url 'study:asq_update' assessment.pk %}">Cancel</a>
        </div>
      </div>

    </form>
  </div>
{% endblock %}

{% block extrajs %}
    <script type="text/javascript">
        $(document).ready(function(){
            var DomainTable = function(){
                this.tbl = $('<table class="table table-condensed table-striped">');
                this.thead = $('<thead>');
                this.colgroup = $('<colgroup>');
                this.tbody = $('<tbody>');
                this.tfoot = $('<tfoot>');
                this.footnotes  = new TableFootnotes();
                this.tbl.append(this.colgroup, this.thead, this.tfoot, this.tbody);
            };
            _.extend(DomainTable.prototype, BaseTable.prototype, {
                addMetricRow: function(data, i){
                    var tr = document.createElement('tr'),
                        th = document.createElement('th'),
                        tdMetric = document.createElement('td'),
                        tdDescr = document.createElement('td');
                    th.innerHTML = i + 1;
                    tr.appendChild(th);
                    tdMetric.innerHTML = data.metric +
                        '<br><br><strong>Required for animal bioassay: </strong>'
                        + HAWCUtils.booleanCheckbox(data.required_animal)
                        + '<br><strong>Required for epidemiological: </strong>'
                        + HAWCUtils.booleanCheckbox(data.required_epi);

                    tdDescr.innerHTML = data.description;
                    tr.appendChild(tdMetric);
                    tr.appendChild(tdDescr);
                    this.tbody.append(tr)
                }
            });

            var displayDomain = function(domain){
                var div  = document.createElement('div'),
                    header = document.createElement('h3'),
                    table = new DomainTable(domain),
                    colgroups = [5, 35, 60],
                    thead = ['ID', 'Metric', 'Description'];

                header.innerHTML = domain.name + ' Domain';
                table.addHeaderRow(thead);
                table.setColGroup(colgroups);
                _.map(domain.metrics, function(metric, i){
                    table.addMetricRow(metric, i)
                })
                div.appendChild(header);
                div.appendChild(table.getTbl()[0])
                return div;
            };

            var displayApproach = function(domains){
                displayDiv = document.getElementById('approach');
                displayDiv.innerHTML = '';
                if (domains.length === 0){
                    var warn = '<div class="alert"><strong>' +
                        $('#id_assessment option:selected').text()
                        + ' does not have a default approach.</strong></div>'
                    displayDiv.innerHTML = warn;
                }
                _.map(domains, function(domain){
                    displayDiv.appendChild(displayDomain(domain));
                })
            };

            var loadApproach = function(){
                $.get("/study/api/domain/?assessment_id=" + $('#id_assessment').val(), function(d){
                    displayApproach(d);
                })
            };

            $('#id_assessment').on('change', loadApproach);
            loadApproach();
        });
    </script>
{% endblock extrajs %}
